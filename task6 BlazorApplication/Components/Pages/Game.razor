@page "/game/{RoomId}"
@rendermode InteractiveServer

@inject NavigationManager Nav
@inject GameService GameService
@inject IJSRuntime JS

@if (room == null)
{
    <p>Loading...</p>
}
else
{
    <div class="container mt-5">

        <div class="row justify-content-center">
            <div class="col-md-5">

                <div class="card shadow-lg">
                    <div class="card-body text-center">

                        <h3 class="mb-3">
                            <i class="bi bi-controller"></i> Tic Tac Toe
                        </h3>

                        <p class="text-muted">
                            Role:
                            <span class="badge bg-primary">@myRole</span>
                        </p>

                        <div class="board d-grid gap-2"
                             style="grid-template-columns:repeat(3, 110px);">

                            @for (int i = 0; i < 9; i++)
                            {
                                int index = i;

                                <button class="btn btn-outline-dark
                                        @(room.Game.GameBoard[index] == "X" ? "cell-x" : "")
                                        @(room.Game.GameBoard[index] == "O" ? "cell-o" : "")
                                        @(room.Game.WinningPattern.Contains(index) ? "btn-warning" : "")"
                                        @onclick="() => room.Game.Move(index, myRole)">
                                    @room.Game.GameBoard[index]
                                </button>
                            }
                        </div>

                        <div class="mt-4">

                            <p class="mb-1">
                                <i class="bi bi-arrow-repeat"></i>
                                Move:
                                <strong>@room.Game.CurrentPlayer</strong>
                            </p>

                            <p>
                                <i class="bi bi-trophy"></i>
                                Winner:
                                <strong class="text-success">@room.Game.Winner</strong>
                            </p>

                        </div>

                        <div class="d-flex justify-content-center gap-2 mt-3">

                            <button class="btn btn-primary"
                                    @onclick="room.Game.Restart">
                                <i class="bi bi-arrow-clockwise"></i>
                                Restart
                            </button>

                        </div>

                    </div>
                </div>

            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public string RoomId { get; set; } = default!;

    GameRoom? room;

    string myRole = "";
    string myId = "";

    System.Timers.Timer? timer;

    protected override void OnInitialized()
    {
        if (!GameService.Rooms.TryGetValue(RoomId, out room))
        {
            Nav.NavigateTo("/");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        myId = await JS.InvokeAsync<string>("getPlayerId");

        AssignRole();

        timer = new System.Timers.Timer(300);
        timer.Elapsed += (_, __) => InvokeAsync(StateHasChanged);
        timer.Start();

        StateHasChanged();
    }

    void AssignRole()
    {
        if (room!.PlayerX == null)
        {
            room.PlayerX = myId;
            myRole = "X";
        }
        else if (room.PlayerO == null)
        {
            room.PlayerO = myId;
            myRole = "O";
        }
        else if (room.PlayerX == myId)
        {
            myRole = "X";
        }
        else if (room.PlayerO == myId)
        {
            myRole = "O";
        }
        else
        {
            myRole = "spectator";
        }
    }

    public void Dispose()
    {
        timer?.Stop();
        timer?.Dispose();
    }
}