@page "/game/{RoomId}"
@rendermode InteractiveServer

@inject NavigationManager Nav
@inject GameService GameService
@inject IJSRuntime JS

<h1>Tic Tac Toe</h1>

@if (room == null)
{
    <p>Loading...</p>
}
else
{
    <h3>Your role: @myRole</h3>

    <div style="display:grid; grid-template-columns:repeat(3,100px); gap:5px;">
        @for (int i = 0; i < 9; i++)
        {
            int index = i;

            <button style="height:100px; font-size:30px;"
                    @onclick="() => room.Game.Move(index, myRole)">
                @room.Game.GameBoard[index]
            </button>
        }
    </div>

    <p>Current move: @room.Game.CurrentPlayer</p>
    <p>Winner: @room.Game.Winner</p>

    <button @onclick="room.Game.Restart">Restart</button>
}

@code {
    [Parameter]
    public string RoomId { get; set; } = default!;

    GameRoom? room;

    string myRole = "";
    string myId = "";

    System.Timers.Timer? timer;

    protected override void OnInitialized()
    {
        if (!GameService.Rooms.TryGetValue(RoomId, out room))
        {
            Nav.NavigateTo("/");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        myId = await JS.InvokeAsync<string>("getPlayerId");

        AssignRole();

        timer = new System.Timers.Timer(300);
        timer.Elapsed += (_, __) => InvokeAsync(StateHasChanged);
        timer.Start();

        StateHasChanged();
    }

    void AssignRole()
    {
        if (room!.PlayerX == null)
        {
            room.PlayerX = myId;
            myRole = "X";
        }
        else if (room.PlayerO == null)
        {
            room.PlayerO = myId;
            myRole = "O";
        }
        else if (room.PlayerX == myId)
        {
            myRole = "X";
        }
        else if (room.PlayerO == myId)
        {
            myRole = "O";
        }
        else
        {
            myRole = "spectator";
        }
    }

    public void Dispose()
    {
        timer?.Stop();
        timer?.Dispose();
    }
}